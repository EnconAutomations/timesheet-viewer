<!DOCTYPE html>

<html lang="en" class="dark">



<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Timesheet Investigation</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <script>

        tailwind.config = {

            darkMode: 'class',

            theme: {

                extend: {

                    fontFamily: {

                        sans: ['Inter', 'sans-serif'],

                        mono: ['JetBrains Mono', 'monospace'],

                    },

                    colors: {

                        slate: {

                            850: '#151f32',

                            900: '#0f172a',

                            950: '#020617',

                        },

                        primary: {

                            400: '#38bdf8',

                            500: '#0ea5e9',

                            600: '#0284c7',

                        }

                    }

                }

            }

        }

    </script>

    <style>
        /* Glassmorphism & Utilities */

        body {

            background-color: #0f172a;

            background-image:

                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),

                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);

            background-attachment: fixed;

            color: #f8fafc;

        }



        .glass-panel {

            background: rgba(30, 41, 59, 0.7);

            backdrop-filter: blur(12px);

            -webkit-backdrop-filter: blur(12px);

            border: 1px solid rgba(255, 255, 255, 0.08);

        }



        .glass-card {

            background: rgba(255, 255, 255, 0.03);

            border: 1px solid rgba(255, 255, 255, 0.05);

            transition: all 0.2s ease;

        }



        .glass-card:hover {

            background: rgba(255, 255, 255, 0.06);

            border-color: rgba(255, 255, 255, 0.1);

        }



        /* Custom Scrollbar */

        ::-webkit-scrollbar {

            width: 6px;

            height: 6px;

        }



        ::-webkit-scrollbar-track {

            background: transparent;

        }



        ::-webkit-scrollbar-thumb {

            background: rgba(255, 255, 255, 0.2);

            border-radius: 10px;

        }



        ::-webkit-scrollbar-thumb:hover {

            background: rgba(255, 255, 255, 0.3);

        }



        /* Vertical Timeline Specifics */

        .v-timeline-container {

            height: 600px;

            overflow-y: auto;

            position: relative;

            background: rgba(15, 23, 42, 0.5);

            border-radius: 12px;

            border: 1px solid rgba(255, 255, 255, 0.05);

        }



        .v-timeline-grid {

            display: grid;

            grid-template-columns: 1fr 60px 1fr;

            /* Left (ST), Axis, Right (Sam) */

            min-height: 100%;

            position: relative;

        }



        .v-time-axis {

            position: relative;

            border-left: 1px solid rgba(255, 255, 255, 0.1);

            border-right: 1px solid rgba(255, 255, 255, 0.1);

            background: rgba(30, 41, 59, 0.3);

        }



        .v-time-marker {

            position: absolute;

            width: 100%;

            text-align: center;

            font-family: 'JetBrains Mono', monospace;

            font-size: 10px;

            color: #64748b;

            border-top: 1px dashed rgba(255, 255, 255, 0.1);

            transform: translateY(-50%);

        }



        .v-event-col {

            position: relative;

        }



        .v-event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 4px;
            padding: 4px;
            font-size: 10px;
            color: white;
            overflow: hidden;
            cursor: pointer;
            /* transition: all 0.2s;  <-- REMOVED to fix stutter/expansion race condition */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
            min-height: 8px;
            /* Allow smaller blocks */
        }

        .v-event-block:hover {
            z-index: 50;
            /* Higher than default 10/20 */

            min-height: 48px !important;
            overflow: visible;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            transform: scale(1.01);
            /* Subtle scale */
        }



        /* Calendar Grid */

        .calendar-grid {

            display: grid;

            grid-template-columns: repeat(7, 1fr);

            gap: 8px;

        }



        .calendar-day {

            aspect-ratio: 1;

            border-radius: 8px;

            padding: 8px;

            cursor: pointer;

            transition: all 0.2s;

        }



        .calendar-day:hover {

            background: rgba(255, 255, 255, 0.05);

        }



        .calendar-day.active {

            background: rgba(56, 189, 248, 0.15);

            border: 1px solid rgba(56, 189, 248, 0.3);

        }



        .calendar-day.empty {

            background: transparent;

            cursor: default;

        }



        /* Animations */

        @keyframes fadeIn {

            from {

                opacity: 0;

                transform: translateY(10px);

            }



            to {

                opacity: 1;

                transform: translateY(0);

            }

        }



        .animate-fade-in {

            animation: fadeIn 0.4s ease-out forwards;

        }
    </style>
    <!-- Custom Tooltip CSS -->
    <style>
        #v-tooltip {
            position: fixed;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            pointer-events: none;
            font-size: 11px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 300px;
            transition: opacity 0.1s;
            opacity: 0;
            white-space: pre-line;
        }

        /* Hover Expansion Fix */
        /* Hover Expansion handled by JS now to avoid shrinking large blocks */
        .v-event-block:hover {
            z-index: 100 !important;
            overflow: visible;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
            background-color: var(--hover-color);
        }

        .v-event-block:hover .truncate {
            white-space: normal;
            overflow: visible;
        }
    </style>
</head>



<body class="h-screen flex flex-col overflow-hidden text-slate-200 font-sans selection:bg-primary-500/30">



    <!-- HEADER -->

    <header class="glass-panel h-16 px-6 flex justify-between items-center shrink-0 z-50 border-b-0">

        <div class="flex items-center gap-4">

            <div
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">

                <i class="fa-solid fa-layer-group text-white text-lg"></i>

            </div>

            <div>

                <h1 class="text-lg font-bold tracking-tight text-white leading-tight">Timesheet<span
                        class="text-primary-400">Reconciliation</span></h1>

                <p class="text-[11px] text-slate-400 font-medium uppercase tracking-wider">Investigation Console</p>

            </div>

        </div>



        <!-- View Switcher (Only visible when data loaded) -->

        <div id="view-switcher" class="hidden bg-slate-800/50 p-1 rounded-lg border border-white/5">



            <button onclick="switchView('weekly')" id="btn-view-weekly"
                class="px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-slate-700 text-white shadow-sm">

                <i class="fa-solid fa-table-cells mr-2"></i>Weekly

            </button>

            <button onclick="switchView('list')" id="btn-view-list"
                class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white">

                <i class="fa-solid fa-list-ul mr-2"></i>List & Detail

            </button>

        </div>



        <div class="flex gap-3">

            <button onclick="resetViewer()"
                class="w-9 h-9 rounded-lg bg-slate-800/50 hover:bg-slate-700 border border-white/10 flex items-center justify-center transition text-slate-400 hover:text-white"
                title="Load New File">

                <i class="fa-solid fa-upload"></i>

            </button>

        </div>

    </header>



    <!-- UPLOAD OVERLAY -->

    <div id="upload-screen" class="fixed inset-0 z-40 flex flex-col items-center justify-center p-6 bg-[#0f172a]">

        <div class="max-w-lg w-full text-center animate-fade-in">

            <div
                class="w-24 h-24 bg-slate-800/50 rounded-3xl flex items-center justify-center mx-auto mb-8 border border-white/5 shadow-2xl shadow-blue-900/20 relative overflow-hidden group">

                <div
                    class="absolute inset-0 bg-gradient-to-tr from-blue-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition duration-500">

                </div>

                <i
                    class="fa-solid fa-cloud-arrow-up text-4xl text-primary-400 group-hover:scale-110 transition duration-300"></i>

            </div>

            <h2 class="text-3xl font-bold text-white mb-3">Import Reconciliation Data</h2>

            <p class="text-slate-400 mb-10 text-lg font-light">Drag & drop your analysis JSON file to begin

                investigation.</p>



            <div id="drop-zone"
                class="border-2 border-dashed border-slate-700 rounded-2xl p-12 transition-all duration-300 hover:border-primary-500/50 hover:bg-primary-500/5 group cursor-pointer relative overflow-hidden">

                <div class="absolute inset-0 bg-grid-white/[0.02] pointer-events-none"></div>

                <i
                    class="fa-solid fa-file-code text-3xl text-slate-600 group-hover:text-primary-400 mb-4 transition"></i>

                <p class="text-base font-medium text-slate-300 group-hover:text-white transition">Drop JSON file here

                </p>

                <p class="text-sm text-slate-500 mt-2">or click to browse</p>

                <input type="file" id="file-input" accept=".json" class="hidden">

            </div>

        </div>

    </div>



    <!-- MAIN CONTENT -->

    <main id="main-content" class="flex-1 flex overflow-hidden hidden relative">



        <!-- PRESERVED: Original Calendar View (kept for future use) -->
        <!-- Uncomment this section to restore calendar view functionality -->
        <!--
        <div id="view-calendar" class="absolute inset-0 p-8 overflow-y-auto hidden z-10 bg-[#0f172a]">
            <div class="max-w-6xl mx-auto">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <div class="flex items-center gap-4 mb-2">
                            <button onclick="changeMonth(-1)"
                                class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white flex items-center justify-center transition">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <h2 class="text-3xl font-bold text-white" id="calendar-month-title">October 2025</h2>
                            <button onclick="changeMonth(1)"
                                class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white flex items-center justify-center transition">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                        <p class="text-slate-400">Overview of discrepancies by date</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="px-3 py-1 rounded bg-red-500/10 border border-red-500/20 text-red-400 text-xs font-medium">
                            High Severity</div>
                        <div class="px-3 py-1 rounded bg-amber-500/10 border border-amber-500/20 text-amber-400 text-xs font-medium">
                            Medium Severity</div>
                    </div>
                </div>
                <div class="glass-panel rounded-2xl p-6">
                    <div class="grid grid-cols-7 gap-8 mb-4 text-slate-500 text-sm font-medium uppercase tracking-wider text-center">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendar-grid" class="calendar-grid"></div>
                </div>
            </div>
        </div>
        -->

        <!-- WEEKLY MANAGER VIEW -->
        <div id="view-weekly" class="absolute inset-0 p-8 overflow-y-auto z-10 bg-[#0f172a]">
            <div class="max-w-7xl mx-auto space-y-6">

                <!-- Week Navigation Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <div class="flex items-center gap-4 mb-2">
                            <button onclick="changeWeek(-1)"
                                class="w-9 h-9 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white flex items-center justify-center transition border border-white/10">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <h2 class="text-3xl font-bold text-white" id="week-title">--</h2>
                            <button onclick="changeWeek(1)"
                                class="w-9 h-9 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white flex items-center justify-center transition border border-white/10">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                            <button onclick="goToCurrentWeek()"
                                class="px-4 py-2 rounded-lg bg-primary-500/20 hover:bg-primary-500/30 text-primary-400 hover:text-primary-300 text-sm font-medium transition border border-primary-500/30">
                                <i class="fa-solid fa-calendar-day mr-2"></i>Today
                            </button>
                        </div>
                        <p class="text-slate-400">High severity discrepancies by technician</p>
                    </div>
                    <div class="text-right">
                        <div class="text-slate-500 text-xs uppercase tracking-wider mb-1">Week Totals</div>
                        <div class="flex gap-3">
                            <div class="px-3 py-1 rounded bg-red-500/10 border border-red-500/20">
                                <span class="text-red-400 text-xl font-bold font-mono" id="week-high-total">0</span>
                                <span class="text-red-400/70 text-xs ml-1">High</span>
                            </div>
                            <div class="px-3 py-1 rounded bg-amber-500/10 border border-amber-500/20">
                                <span class="text-amber-400 text-xl font-bold font-mono" id="week-med-total">0</span>
                                <span class="text-amber-400/70 text-xs ml-1">Med</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Grid -->
                <div class="glass-panel rounded-2xl p-6">
                    <div id="weekly-grid">
                        <!-- Grid will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Technician Summary Table -->
                <div class="glass-panel rounded-2xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-chart-bar text-primary-400"></i>
                        Technician Summary
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full" id="tech-summary-table">
                            <thead>
                                <tr class="border-b border-white/10">
                                    <th
                                        class="text-left py-3 px-4 text-slate-400 text-xs font-medium uppercase tracking-wider">
                                        Technician</th>
                                    <th
                                        class="text-center py-3 px-4 text-slate-400 text-xs font-medium uppercase tracking-wider">
                                        High</th>
                                    <th
                                        class="text-center py-3 px-4 text-slate-400 text-xs font-medium uppercase tracking-wider">
                                        Medium</th>
                                    <th
                                        class="text-center py-3 px-4 text-slate-400 text-xs font-medium uppercase tracking-wider">
                                        Total</th>
                                </tr>
                            </thead>
                            <tbody id="tech-summary-body">
                                <!-- Rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>



        <!-- LIST & DETAIL VIEW -->

        <div id="view-list" class="absolute inset-0 flex w-full h-full">



            <!-- SIDEBAR: Employee List -->

            <aside id="sidebar"
                class="w-96 glass-panel border-r border-white/5 flex flex-col shrink-0 z-20 transition-all duration-300 relative">

                <div class="p-4 border-b border-white/5 space-y-4">

                    <!-- Header Row -->
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-white tracking-tight">Discrepancies</h2>
                            <p class="text-xs text-slate-400 font-medium mt-1"><span id="record-count"
                                    class="text-white">0</span>
                                records found</p>
                        </div>
                        <button onclick="exportToCSV()"
                            class="p-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition border border-white/5"
                            title="Export Filtered CSV">
                            <i class="fa-solid fa-download"></i>
                        </button>
                        <button onclick="toggleSidebar()" class="lg:hidden text-white">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>

                    <!-- Search -->

                    <div class="relative group">

                        <i
                            class="fa-solid fa-search absolute left-3 top-3 text-slate-500 group-focus-within:text-primary-400 transition"></i>

                        <input type="text" id="search-input" placeholder="Search employees..."
                            class="w-full pl-10 pr-4 py-2.5 bg-slate-800/50 border border-white/10 rounded-xl text-sm text-white placeholder-slate-500 focus:outline-none focus:border-primary-500/50 focus:ring-1 focus:ring-primary-500/50 transition">

                    </div>



                    <!-- Filters -->

                    <div class="flex gap-2">

                        <select id="severity-filter"
                            class="flex-1 bg-slate-800/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none focus:border-primary-500/50">

                            <option value="ALL">All Severities</option>

                            <option value="HIGH" selected>High Only</option>

                            <option value="MEDIUM">Medium Only</option>

                        </select>

                        <select id="flag-filter"
                            class="flex-1 bg-slate-800/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none focus:border-primary-500/50">

                            <option value="ALL">All Flags</option>

                            <option value="EXCESS_HOURS_CLAIMED">Excess Hours</option>

                            <option value="VEHICLE_USE_AFTER_SHIFT">After Shift</option>

                        </select>

                    </div>

                    <!-- Sort -->
                    <select id="sort-filter"
                        class="w-full bg-slate-800/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none focus:border-primary-500/50">
                        <option value="SEVERITY">Sort by: Severity (High to Low)</option>
                        <option value="NAME">Sort by: Name (A-Z)</option>
                    </select>

                </div>





                <div id="employee-list" class="flex-1 overflow-y-auto p-3 space-y-2">

                    <!-- Employee Items -->

                </div>



                <div class="p-3 border-t border-white/5 text-xs text-center text-slate-500 font-mono">

                    <span id="record-count">0</span> Records Found

                </div>

            </aside>



            <!-- DETAIL CONTENT -->

            <div class="flex-1 overflow-y-auto bg-slate-900/50 p-8 relative transition-all duration-300">

                <!-- Show Sidebar Button (Hidden by default) -->
                <button id="show-sidebar-btn" onclick="toggleSidebar()"
                    class="hidden absolute top-4 left-4 z-50 w-8 h-8 flex items-center justify-center bg-slate-800/80 backdrop-blur rounded-lg border border-white/10 text-slate-400 hover:text-white hover:bg-slate-700 transition shadow-lg">
                    <i class="fa-solid fa-chevron-right"></i>
                </button>

                <!-- Empty State -->

                <!-- Empty State -->
                <div id="empty-state"
                    class="flex-1 flex flex-col items-center justify-center text-slate-500 h-full min-h-[400px]">
                    <div
                        class="w-20 h-20 rounded-full bg-slate-800/50 flex items-center justify-center mb-4 border border-white/5">
                        <i class="fa-regular fa-hand-point-left text-3xl opacity-50"></i>
                    </div>
                    <p class="text-lg font-light">Select an employee to investigate</p>
                </div>



                <!-- Detail View -->

                <div id="detail-view" class="hidden max-w-6xl mx-auto space-y-6 pb-20">



                    <!-- Header Card -->

                    <div class="glass-panel rounded-2xl p-8 relative overflow-hidden border border-white/10">

                        <div class="absolute top-0 left-0 w-1.5 h-full bg-red-500" id="detail-severity-bar"></div>



                        <div class="flex justify-between items-start relative z-10">

                            <div>

                                <div class="flex items-center gap-4 mb-2">

                                    <h2 class="text-3xl font-bold text-white tracking-tight" id="detail-name">Employee

                                        Name</h2>

                                    <span id="detail-severity-badge"
                                        class="px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider bg-red-500/20 text-red-400 border border-red-500/20">HIGH</span>

                                </div>

                                <div class="flex items-center gap-6 text-sm text-slate-400">

                                    <div class="flex items-center gap-2">

                                        <i class="fa-regular fa-calendar text-slate-500"></i>

                                        <span id="detail-date">YYYY-MM-DD</span>

                                    </div>

                                    <div class="flex items-center gap-2">

                                        <i class="fa-solid fa-triangle-exclamation text-amber-500"></i>

                                        <span id="detail-flag" class="text-slate-200">Flag Type</span>

                                    </div>

                                </div>

                            </div>

                            <div class="text-right">

                                <div class="text-4xl font-bold text-white font-mono tracking-tight" id="detail-diff">

                                    0.0h</div>

                                <div class="text-xs text-slate-500 uppercase font-bold tracking-wider mt-1">Discrepancy

                                </div>

                            </div>

                        </div>



                        <!-- Analysis Box -->

                        <div class="mt-8 bg-slate-950/50 rounded-xl p-5 border border-white/5">

                            <h3 class="text-xs font-bold text-primary-400 uppercase mb-3 flex items-center gap-2">

                                <i class="fa-solid fa-chart-line"></i> Analysis

                            </h3>

                            <p class="text-slate-300 text-sm leading-relaxed" id="detail-description">Analysis text...

                            </p>

                            <div class="mt-4 pt-4 border-t border-white/5 grid grid-cols-2 gap-6 text-sm">

                                <div>
                                    <div class="text-slate-500 text-xs uppercase mb-1">ðŸ“‹ ServiceTitan Window</div>
                                    <div class="text-white font-mono" id="detail-st-window">--</div>
                                </div>

                                <div>
                                    <div class="text-slate-500 text-xs uppercase mb-1">ðŸš— Samsara Window</div>
                                    <div class="text-white font-mono" id="detail-sam-window">--</div>
                                </div>

                                <div>
                                    <span class="text-slate-500">Unauthorized Miles:</span>
                                    <span class="text-white ml-2 font-mono" id="detail-miles">0</span> mi
                                </div>

                                <div>
                                    <span class="text-slate-500">Unauthorized Time:</span>
                                    <span class="text-white ml-2 font-mono" id="detail-unauth-time">0</span>
                                </div>

                            </div>

                        </div>

                    </div>



                    <!-- Vertical Timeline Visualization -->

                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-timeline text-slate-500"></i> Activity Comparison
                        </h3>
                        <div class="flex items-center gap-4 text-[10px] font-medium text-slate-400">
                            <span class="text-blue-400">ServiceTitan (Left)</span>
                            <span class="text-emerald-400">Samsara Trips (Right)</span>
                            <span class="text-amber-400">âš  Potential Work</span>
                            <div class="px-4 border-l border-white/10 ml-4 flex items-center gap-1">
                                <button onclick="switchTimelineView('vertical')" id="btn-tl-vertical"
                                    class="px-2 py-1 rounded bg-slate-700 text-white text-xs border border-white/10 transition"
                                    title="Vertical View">
                                    <i class="fa-solid fa-arrows-up-down"></i>
                                </button>
                                <button onclick="switchTimelineView('horizontal')" id="btn-tl-horizontal"
                                    class="px-2 py-1 rounded bg-slate-800 text-slate-400 text-xs border border-white/10 hover:text-white transition"
                                    title="Horizontal View">
                                    <i class="fa-solid fa-arrows-left-right"></i>
                                </button>
                            </div>

                            <!-- Zoom controls -->
                            <div class="flex items-center gap-1 ml-4 border-l border-white/10 pl-4">
                                <button onclick="changeZoom(-0.5)"
                                    class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 border border-white/10 text-slate-300 transition"
                                    title="Zoom Out">
                                    <i class="fa-solid fa-minus text-xs"></i>
                                </button>
                                <span id="zoom-level"
                                    class="px-2 text-slate-400 font-mono min-w-[40px] text-center">1.0x</span>
                                <button onclick="changeZoom(0.5)"
                                    class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 border border-white/10 text-slate-300 transition"
                                    title="Zoom In">
                                    <i class="fa-solid fa-plus text-xs"></i>
                                </button>
                                <button onclick="resetZoom()"
                                    class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 border border-white/10 text-slate-300 transition"
                                    title="Reset Zoom">
                                    <i class="fa-solid fa-expand text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- TIMELINE CONTAINER WRAPPER -->
                    <div class="relative min-h-[400px]">

                        <!-- Vertical View -->
                        <div id="timeline-view-vertical">
                            <div class="v-timeline-container" id="timeline-scroll-area">
                                <div class="v-timeline-grid" id="v-timeline-grid">
                                    <!-- Left Column: ServiceTitan -->
                                    <div class="v-event-col" id="col-st"></div>

                                    <!-- Center: Time Axis -->
                                    <div class="v-time-axis" id="col-axis"></div>

                                    <!-- Right Column: Samsara -->
                                    <div class="v-event-col" id="col-sam"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Horizontal View -->
                        <div id="timeline-view-horizontal"
                            class="hidden overflow-x-auto border border-white/10 rounded-lg bg-slate-900/50">
                            <!-- Horizontal content injected by JS -->
                            <div id="h-timeline-container" class="relative items-center">
                                <!-- Axes and Events go here -->
                            </div>
                        </div>

                    </div>

                </div>



                <!-- Side-by-Side Details -->

                <div class="grid grid-cols-2 gap-6">

                    <!-- ServiceTitan List -->

                    <div class="glass-panel rounded-2xl overflow-hidden border border-white/10 flex flex-col h-[500px]">

                        <div class="p-4 border-b border-white/5 bg-blue-500/5 flex justify-between items-center">

                            <h3 class="font-bold text-blue-100 text-sm">ServiceTitan Log</h3>

                            <span class="text-xs font-mono text-blue-300 bg-blue-500/10 px-2 py-1 rounded"
                                id="st-total">0.0h</span>

                        </div>

                        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="list-st"></div>

                    </div>



                    <!-- Samsara List -->

                    <div class="glass-panel rounded-2xl overflow-hidden border border-white/10 flex flex-col h-[500px]">

                        <div class="p-4 border-b border-white/5 bg-emerald-500/5 flex justify-between items-center">

                            <h3 class="font-bold text-emerald-100 text-sm">Samsara Log</h3>

                            <span class="text-xs font-mono text-emerald-300 bg-emerald-500/10 px-2 py-1 rounded"
                                id="sam-total">0.0h</span>

                        </div>

                        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="list-sam"></div>

                    </div>

                </div>



            </div>

        </div>

        </div>

    </main>



    <script>

        // --- STATE ---

        let appData = null;

        let groupedData = {}; // { "YYYY-MM-DD": [items] }

        let calendarDate = new Date(); // Current month being viewed

        let currentView = 'weekly'; // Default to weekly view

        let currentFilter = { search: '', severity: 'HIGH', flag: 'ALL', sort: 'SEVERITY' };

        let timelineZoom = 1.0; // Zoom factor for timeline (0.5x to 3.0x)

        let currentWeekStart = null; // Current week start date for weekly view



        // --- INITIALIZATION ---

        const dropZone = document.getElementById('drop-zone');

        const fileInput = document.getElementById('file-input');



        // Drag & Drop

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {

            e.preventDefault();

            dropZone.classList.add('border-primary-500', 'bg-primary-500/10');

        });

        dropZone.addEventListener('dragleave', () => {

            dropZone.classList.remove('border-primary-500', 'bg-primary-500/10');

        });

        dropZone.addEventListener('drop', (e) => {

            e.preventDefault();

            dropZone.classList.remove('border-primary-500', 'bg-primary-500/10');

            handleFiles(e.dataTransfer.files);

        });

        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));



        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('detail-view').classList.contains('hidden')) return;

            if (e.key === 'Escape' || e.key === 'ArrowLeft') {
                closeDetail();
            }
        });

        function handleFiles(files) {

            if (files.length === 0) return;

            const reader = new FileReader();

            reader.onload = (e) => {

                let json;
                try {
                    json = JSON.parse(e.target.result);
                } catch (err) {
                    console.error('Error parsing JSON:', err);
                    alert('Invalid JSON file. Please ensure you are uploading a valid JSON report file.');
                    return;
                }

                try {
                    loadData(json);
                } catch (err) {
                    console.error('Error loading data:', err);
                    alert('Error loading data. See console for details: ' + err.message);
                }
            };

            reader.readAsText(files[0]);
        }



        function loadData(json) {

            appData = json;



            // Group data by date for calendar

            groupedData = {};

            appData.discrepancies.forEach(item => {

                if (!groupedData[item.date]) groupedData[item.date] = [];

                groupedData[item.date].push(item);

            });



            const uploadScreen = document.getElementById('upload-screen');
            if (uploadScreen) uploadScreen.classList.add('hidden');

            const mainContent = document.getElementById('main-content');
            if (mainContent) mainContent.classList.remove('hidden');

            const viewSwitcher = document.getElementById('view-switcher');
            if (viewSwitcher) {
                viewSwitcher.classList.remove('hidden');
                viewSwitcher.classList.add('flex');
            }



            renderSidebar();



            // Initialize weekly view with first data date

            const dates = Object.keys(groupedData).sort();

            if (dates.length > 0) {
                // Sort dates to ensure order
                dates.sort();

                // Helper to parse YYYY-MM-DD to Local Midnight Date
                const parseLocal = (s) => {
                    const [y, m, d] = s.split('-').map(Number);
                    return new Date(y, m - 1, d);
                };

                // Set week to LAST date with data (most recent)
                const lastDateStr = dates[dates.length - 1];
                const lastDate = parseLocal(lastDateStr);

                const dayOfWeek = lastDate.getDay();
                const diff = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek; // Adjust to Monday

                currentWeekStart = new Date(lastDate);
                currentWeekStart.setDate(lastDate.getDate() + diff);

                // For calendar, also default to the month of the last date
                calendarDate = new Date(lastDate);
                calendarDate.setDate(1);
            }

            // Default to weekly view
            switchView('weekly');
        }



        function resetViewer() {

            location.reload(); // Simplest reset

        }



        function switchView(view, pushState = true) {

            currentView = view;
            if (pushState) updateHistory(view);

            const weeklyBtn = document.getElementById('btn-view-weekly');
            const listBtn = document.getElementById('btn-view-list');

            const calView = document.getElementById('view-calendar');
            const weeklyView = document.getElementById('view-weekly');
            const listView = document.getElementById('view-list');

            // Reset all buttons to inactive state
            const inactiveClass = "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-white";
            const activeClass = "px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-slate-700 text-white shadow-sm";

            if (weeklyBtn) weeklyBtn.className = inactiveClass;
            if (listBtn) listBtn.className = inactiveClass;

            // Hide all views
            if (calView) calView.classList.add('hidden');
            if (weeklyView) weeklyView.classList.add('hidden');
            if (listView) listView.classList.add('hidden');

            // Show selected view and activate its button
            if (view === 'weekly') {
                if (weeklyBtn) weeklyBtn.className = activeClass;
                if (weeklyView) {
                    weeklyView.classList.remove('hidden');
                    renderWeekView();
                }
            } else {
                if (listBtn) listBtn.className = activeClass;
                if (listView) listView.classList.remove('hidden');
            }

        }




        // --- WEEKLY VIEW LOGIC ---

        function changeWeek(offset) {
            if (!currentWeekStart) return;
            currentWeekStart.setDate(currentWeekStart.getDate() + (offset * 7));
            renderWeekView();
        }

        function goToCurrentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek;
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() + diff);
            renderWeekView();
        }

        function formatDateYMD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function aggregateWeekData() {
            if (!currentWeekStart || !appData || !appData.discrepancies) {
                return { weekData: {}, weekDates: [], techNames: [] };
            }

            const weekData = {};
            const weekDates = [];

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                weekDates.push(formatDateYMD(date));
            }

            appData.discrepancies.forEach(item => {
                if (!weekDates.includes(item.date)) return;

                if (!weekData[item.employeeName]) {
                    weekData[item.employeeName] = {};
                    weekDates.forEach(d => {
                        weekData[item.employeeName][d] = { HIGH: 0, MEDIUM: 0 };
                    });
                }

                const severity = item.severity === 'HIGH' ? 'HIGH' : 'MEDIUM';
                weekData[item.employeeName][item.date][severity]++;
            });

            const techNames = Object.keys(weekData).sort();

            return { weekData, weekDates, techNames };
        }

        function renderWeekView() {
            if (!currentWeekStart) return;

            const { weekData, weekDates, techNames: allTechNames } = aggregateWeekData();

            // Filter to show only techs with HIGH severity items this week
            const techNames = allTechNames.filter(tech => {
                let hasHigh = false;
                weekDates.forEach(d => {
                    if (weekData[tech][d].HIGH > 0) hasHigh = true;
                });
                return hasHigh;
            });

            const startDate = new Date(currentWeekStart);
            const endDate = new Date(currentWeekStart);
            endDate.setDate(startDate.getDate() + 6);
            const titleStr = `Week of ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            document.getElementById('week-title').innerText = titleStr;

            let weekHighTotal = 0;
            let weekMedTotal = 0;
            techNames.forEach(tech => {
                weekDates.forEach(date => {
                    weekHighTotal += weekData[tech][date].HIGH;
                    weekMedTotal += weekData[tech][date].MEDIUM;
                });
            });
            document.getElementById('week-high-total').innerText = weekHighTotal;
            document.getElementById('week-med-total').innerText = weekMedTotal;

            const gridContainer = document.getElementById('weekly-grid');
            gridContainer.innerHTML = '';

            if (techNames.length === 0) {
                gridContainer.innerHTML = `
                    <div class="text-center py-12 text-slate-500">
                        <i class="fa-solid fa-calendar-xmark text-4xl mb-4 opacity-50"></i>
                        <p class="text-lg">No discrepancies for this week</p>
                    </div>
                `;
                renderTechSummaryTable({}, []);
                return;
            }

            let gridHTML = '<div class="overflow-x-auto">';
            gridHTML += '<table class="w-full border-collapse">';

            gridHTML += '<thead><tr class="border-b border-white/10">';
            gridHTML += '<th class="text-left py-3 px-4 text-slate-400 text-xs font-medium uppercase tracking-wider sticky left-0 bg-slate-800/50 backdrop-blur z-10">Technician</th>';
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            weekDates.forEach((dateStr, idx) => {
                const date = new Date(dateStr);
                const dayName = dayNames[idx];
                const monthDay = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
                gridHTML += `<th class="text-center py-3 px-4 min-w-[80px]">
                    <div class="text-slate-400 text-xs font-medium uppercase tracking-wider">${dayName}</div>
                    <div class="text-slate-500 text-[10px] mt-0.5">${monthDay}</div>
                </th>`;
            });
            gridHTML += '</tr></thead>';

            gridHTML += '<tbody>';
            techNames.forEach(techName => {
                gridHTML += '<tr class="border-b border-white/5 hover:bg-white/[0.02] transition">';
                gridHTML += `<td class="py-3 px-4 font-medium text-slate-200 sticky left-0 bg-slate-800/70 backdrop-blur z-10">${techName}</td>`;

                weekDates.forEach(dateStr => {
                    const high = weekData[techName][dateStr].HIGH;
                    const med = weekData[techName][dateStr].MEDIUM;
                    const total = high + med;

                    let bgClass, textClass, borderClass;
                    if (high === 0) {
                        bgClass = 'bg-slate-800/20';
                        textClass = 'text-slate-600';
                        borderClass = 'border-slate-700/30';
                    } else {
                        bgClass = 'bg-red-500/20 hover:bg-red-500/30';
                        textClass = 'text-red-400';
                        borderClass = 'border-red-500/30';
                    }

                    const clickable = total > 0 ? 'cursor-pointer' : '';
                    const onclick = total > 0 ? `onclick="openWeekCell('${techName}', '${dateStr}')"` : '';

                    gridHTML += `<td class="text-center py-3 px-4">
                        <div class="${bgClass} ${clickable} py-2 px-3 rounded-lg border ${borderClass} transition-all" ${onclick}>
                            <div class="${textClass} text-lg font-bold font-mono">${high}</div>
                            ${med > 0 ? `<div class="text-slate-500 text-[10px] mt-0.5">+${med} med</div>` : ''}
                        </div>
                    </td>`;
                });

                gridHTML += '</tr>';
            });
            gridHTML += '</tbody></table></div>';

            gridContainer.innerHTML = gridHTML;

            renderTechSummaryTable(weekData, techNames);
        }

        function renderTechSummaryTable(weekData, techNames) {
            const tbody = document.getElementById('tech-summary-body');
            tbody.innerHTML = '';

            if (techNames.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-slate-500">No data for this week</td></tr>';
                return;
            }

            const techTotals = techNames.map(techName => {
                let high = 0, med = 0;
                Object.values(weekData[techName]).forEach(counts => {
                    high += counts.HIGH;
                    med += counts.MEDIUM;
                });
                return { name: techName, high, med, total: high + med };
            }).filter(t => t.high > 0);

            techTotals.sort((a, b) => b.high - a.high || a.name.localeCompare(b.name));

            techTotals.forEach(tech => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white/5 hover:bg-white/[0.02] transition cursor-pointer';
                row.onclick = () => openTechSummary(tech.name);

                row.innerHTML = `
                    <td class="py-3 px-4 text-slate-200 font-medium">${tech.name}</td>
                    <td class="py-3 px-4 text-center">
                        <span class="inline-block px-2 py-1 rounded ${tech.high > 0 ? 'bg-red-500/10 text-red-400' : 'text-slate-600'} font-mono font-bold">
                            ${tech.high}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center">
                        <span class="inline-block px-2 py-1 rounded ${tech.med > 0 ? 'bg-amber-500/10 text-amber-400' : 'text-slate-600'} font-mono">
                            ${tech.med}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-center text-slate-300 font-mono font-bold">${tech.total}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function openWeekCell(techName, dateStr) {
            currentFilter.search = techName;
            currentFilter.severity = 'ALL';
            document.getElementById('search-input').value = techName;
            document.getElementById('severity-filter').value = 'ALL';
            renderSidebar();
            switchView('list');

            const firstHigh = appData.discrepancies.find(i =>
                i.employeeName === techName && i.date === dateStr && i.severity === 'HIGH'
            );
            const firstAny = appData.discrepancies.find(i =>
                i.employeeName === techName && i.date === dateStr
            );
            const item = firstHigh || firstAny;
            if (item) loadDetail(item);
        }

        // --- HISTORY & NAVIGATION SUPPORT ---

        window.addEventListener('popstate', (event) => {
            const state = event.state;
            if (!state) {
                // If no state, default to initial view (likely weekly)
                closeDetail(false);
                switchView('weekly', false);
                return;
            }

            if (state.view === 'detail' && state.itemId) {
                // Determine source for detail lookup (search all discrepancies)
                const item = appData.discrepancies.find(i =>
                    (i.employeeName + '_' + i.date) === state.itemId
                );
                if (item) {
                    loadDetail(item, false);
                } else {
                    console.warn('History item not found:', state.itemId);
                    closeDetail(false);
                }
            } else {
                closeDetail(false);
                if (state.view) switchView(state.view, false);
            }
        });

        function updateHistory(view, itemId = null) {
            const url = new URL(window.location);
            url.searchParams.set('view', view);
            if (itemId) {
                url.searchParams.set('id', itemId);
            } else {
                url.searchParams.delete('id');
            }

            const state = { view, itemId };
            window.history.pushState(state, '', url);
        }

        function closeDetail(updateHistoryState = true) {
            document.getElementById('detail-view').classList.add('hidden');
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.classList.remove('hidden');

            if (updateHistoryState) {
                // When closing detail, we go back to the current main view
                updateHistory(currentView);
            }
        }

        function openTechSummary(techName) {
            currentFilter.search = techName;
            currentFilter.severity = 'ALL';
            currentFilter.flag = 'ALL';
            document.getElementById('search-input').value = techName;
            document.getElementById('severity-filter').value = 'ALL';
            document.getElementById('flag-filter').value = 'ALL';
            renderSidebar();
            switchView('list');

            const firstItem = appData.discrepancies.find(i => i.employeeName === techName);
            if (firstItem) loadDetail(firstItem);
        }

        // --- CALENDAR LOGIC ---

        function changeMonth(delta) {

            calendarDate.setMonth(calendarDate.getMonth() + delta);

            renderCalendar();

        }



        function renderCalendar() {

            const grid = document.getElementById('calendar-grid');

            grid.innerHTML = '';



            const year = calendarDate.getFullYear();

            const month = calendarDate.getMonth(); // 0-indexed



            document.getElementById('calendar-month-title').innerText = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });



            // Days in month

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const startDay = new Date(year, month, 1).getDay(); // 0 = Sun



            // Empty slots for start

            for (let i = 0; i < startDay; i++) {

                const el = document.createElement('div');

                el.className = 'calendar-day empty';

                grid.appendChild(el);

            }



            // Days

            for (let d = 1; d <= daysInMonth; d++) {

                // Format date as YYYY-MM-DD (local time safe)

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                const items = groupedData[dateStr] || [];



                const el = document.createElement('div');

                el.className = `calendar-day glass-card flex flex-col justify-between ${items.length > 0 ? 'hover:bg-slate-800 cursor-pointer' : 'opacity-50'}`;



                let indicators = '';

                let highCount = items.filter(i => i.severity === 'HIGH').length;

                let medCount = items.filter(i => i.severity !== 'HIGH').length;



                if (items.length > 0) {

                    el.onclick = () => openDateInList(dateStr);

                    indicators = `

                            <div class="flex gap-1 mt-1 flex-wrap">

                                ${highCount > 0 ? `<span class="h-1.5 w-1.5 rounded-full bg-red-500" title="${highCount} High"></span>`.repeat(Math.min(highCount, 5)) : ''}

                                ${medCount > 0 ? `<span class="h-1.5 w-1.5 rounded-full bg-amber-500" title="${medCount} Medium"></span>`.repeat(Math.min(medCount, 3)) : ''}

                            </div>

                        `;

                }



                el.innerHTML = `

                        <div class="text-right text-sm font-medium ${items.length > 0 ? 'text-white' : 'text-slate-600'}">${d}</div>

                        <div>${indicators}</div>

                    `;

                grid.appendChild(el);

            }

        }



        function openDateInList(dateStr) {

            // Filter list to this date

            document.getElementById('search-input').value = dateStr; // Hacky but works with filter logic

            currentFilter.search = dateStr;

            renderSidebar();

            switchView('list');



            // Auto-select first item

            const firstItem = appData.discrepancies.find(i => i.date === dateStr);

            if (firstItem) loadDetail(firstItem);

        }



        // --- SIDEBAR & FILTER ---

        document.getElementById('search-input').addEventListener('input', (e) => {

            currentFilter.search = e.target.value.toLowerCase();

            renderSidebar();

        });

        document.getElementById('severity-filter').addEventListener('change', (e) => {

            currentFilter.severity = e.target.value;

            renderSidebar();

        });

        document.getElementById('flag-filter').addEventListener('change', (e) => {
            currentFilter.flag = e.target.value;
            renderSidebar();
        });

        document.getElementById('sort-filter').addEventListener('change', (e) => {
            currentFilter.sort = e.target.value;
            renderSidebar();
        });

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const showBtn = document.getElementById('show-sidebar-btn');
            if (sb.classList.contains('hidden')) {
                sb.classList.remove('hidden');
                showBtn.classList.add('hidden');
            } else {
                sb.classList.add('hidden');
                showBtn.classList.remove('hidden');
            }
        }

        function renderSidebar() {
            const listContainer = document.getElementById('employee-list');
            listContainer.innerHTML = '';

            if (!currentFilter.sort) currentFilter.sort = 'SEVERITY';

            const filtered = appData.discrepancies.filter(item => {
                const searchStr = (item.employeeName + ' ' + item.date).toLowerCase();
                const matchesSearch = searchStr.includes(currentFilter.search);
                const matchesSeverity = currentFilter.severity === 'ALL' || item.severity === currentFilter.severity;
                const matchesFlag = currentFilter.flag === 'ALL' || item.flag === currentFilter.flag;
                return matchesSearch && matchesSeverity && matchesFlag;
            });

            // Sort
            filtered.sort((a, b) => {
                if (currentFilter.sort === 'NAME') return a.employeeName.localeCompare(b.employeeName);
                const rank = { 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
                const rA = rank[a.severity] || 0;
                const rB = rank[b.severity] || 0;
                if (rA !== rB) return rB - rA;
                return a.employeeName.localeCompare(b.employeeName);
            });



            document.getElementById('record-count').innerText = filtered.length;



            filtered.forEach(item => {

                const el = document.createElement('div');

                const isHigh = item.severity === 'HIGH';

                el.className = `p-3 rounded-lg cursor-pointer border transition-all duration-200 hover:translate-x-1 ${isHigh ? 'bg-red-500/5 border-red-500/20 hover:bg-red-500/10' : 'bg-slate-800/50 border-white/5 hover:bg-slate-800'}`;



                el.innerHTML = `

                        <div class="flex justify-between items-start mb-1">

                            <h4 class="font-bold text-sm text-slate-200 truncate pr-2">${item.employeeName}</h4>

                            <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${isHigh ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-slate-400'}">${item.severity}</span>

                        </div>

                        <div class="flex justify-between items-center">

                            <div class="text-xs text-slate-500 font-mono">${item.date}</div>

                            <div class="text-[10px] text-slate-400 truncate max-w-[120px]">${formatFlag(item.flag)}</div>

                        </div>

                    `;

                el.onclick = () => loadDetail(item);

                listContainer.appendChild(el);

            });

        }



        function formatFlag(flag) {

            return flag.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());

        }



        // --- DETAIL VIEW ---

        // --- DETAIL VIEW ---

        function loadDetail(item, pushState = true) {

            if (pushState) {
                // Unique ID for URL/History
                const uniqueId = item.employeeName + '_' + item.date;
                updateHistory('detail', uniqueId);
            }

            document.getElementById('empty-state').classList.add('hidden');

            document.getElementById('detail-view').classList.remove('hidden');



            // Header Data

            document.getElementById('detail-name').innerText = item.employeeName;

            document.getElementById('detail-date').innerText = formatDateAmerican(item.date);

            document.getElementById('detail-flag').innerText = formatFlag(item.flag);



            const isHigh = item.severity === 'HIGH';

            const sevBadge = document.getElementById('detail-severity-badge');

            sevBadge.innerText = item.severity;

            sevBadge.className = `px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider border ${isHigh ? 'bg-red-500/20 text-red-400 border-red-500/20' : 'bg-amber-500/20 text-amber-400 border-amber-500/20'}`;

            document.getElementById('detail-severity-bar').className = `absolute top-0 left-0 w-1.5 h-full ${isHigh ? 'bg-red-500' : 'bg-amber-500'}`;



            document.getElementById('detail-diff').innerText = (item.analysis.hourDifference > 0 ? '+' : '') + formatDuration(Math.abs(item.analysis.hourDifference)) + ' (' + item.analysis.hourDifference.toFixed(2) + 'h)';

            document.getElementById('detail-diff').className = `text-4xl font-bold font-mono tracking-tight ${item.analysis.hourDifference > 0 ? 'text-red-400' : 'text-white'}`;



            document.getElementById('detail-description').innerText = item.analysis.issueDescription;

            document.getElementById('detail-miles').innerText = item.analysis.unauthorizedMiles;

            document.getElementById('detail-unauth-time').innerText = formatDuration(item.analysis.unauthorizedHours) + ' (' + item.analysis.unauthorizedHours.toFixed(2) + 'h)';

            // Work Windows
            document.getElementById('detail-st-window').innerText = `${item.serviceTitan.workWindow.start} - ${item.serviceTitan.workWindow.end} (${item.serviceTitan.workWindow.duration})`;
            document.getElementById('detail-sam-window').innerText = `${item.samsara.workWindow.start} - ${item.samsara.workWindow.end} (${item.samsara.workWindow.duration})`;



            document.getElementById('st-total').innerText = formatDuration(item.serviceTitan.totalClaimedHours) + ' (' + item.serviceTitan.totalClaimedHours.toFixed(2) + 'h)';

            document.getElementById('sam-total').innerText = formatDuration(item.samsara.totalVehicleHours) + ' (' + item.samsara.totalVehicleHours.toFixed(2) + 'h)';



            renderTimeline(item);

            renderLists(item);

        }

        // --- ZOOM CONTROLS ---
        function changeZoom(delta) {
            timelineZoom = Math.max(0.5, Math.min(3.0, timelineZoom + delta));
            document.getElementById('zoom-level').innerText = timelineZoom.toFixed(1) + 'x';

            // Re-render timeline with current item
            const currentName = document.getElementById('detail-name').innerText;
            const displayedDate = document.getElementById('detail-date').innerText;
            // Convert back to YYYY-MM-DD for comparison
            const currentDate = displayedDate.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$1-$2');
            const currentItem = appData.discrepancies.find(d =>
                d.employeeName === currentName && d.date === currentDate
            );
            if (currentItem) renderTimeline(currentItem);
        }

        function resetZoom() {
            timelineZoom = 1.0;
            document.getElementById('zoom-level').innerText = '1.0x';

            // Re-render timeline with current item
            const currentName = document.getElementById('detail-name').innerText;
            const displayedDate = document.getElementById('detail-date').innerText;
            // Convert back to YYYY-MM-DD for comparison
            const currentDate = displayedDate.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$1-$2');
            const currentItem = appData.discrepancies.find(d =>
                d.employeeName === currentName && d.date === currentDate
            );
            if (currentItem) renderTimeline(currentItem);
        }



        // --- ADVANCED TIMELINE RENDERER ---

        let timelineMode = 'vertical'; // 'vertical' or 'horizontal'

        function switchTimelineView(mode) {
            timelineMode = mode;

            // UI Toggle
            const vBtn = document.getElementById('btn-tl-vertical');
            const hBtn = document.getElementById('btn-tl-horizontal');

            if (mode === 'vertical') {
                vBtn.className = "px-2 py-1 rounded bg-slate-700 text-white text-xs border border-white/10 transition shadow-sm";
                hBtn.className = "px-2 py-1 rounded bg-slate-800 text-slate-400 text-xs border border-white/10 hover:text-white transition";

                document.getElementById('timeline-view-vertical').classList.remove('hidden');
                document.getElementById('timeline-view-horizontal').classList.add('hidden');
            } else {
                vBtn.className = "px-2 py-1 rounded bg-slate-800 text-slate-400 text-xs border border-white/10 hover:text-white transition";
                hBtn.className = "px-2 py-1 rounded bg-slate-700 text-white text-xs border border-white/10 transition shadow-sm";

                document.getElementById('timeline-view-vertical').classList.add('hidden');
                document.getElementById('timeline-view-horizontal').classList.remove('hidden');
            }

            // Trigger re-render of current item to populate the new view
            const currentName = document.getElementById('detail-name').innerText;
            const displayedDate = document.getElementById('detail-date').innerText;
            const currentDate = displayedDate.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$1-$2');
            const currentItem = appData.discrepancies.find(d =>
                d.employeeName === currentName && d.date === currentDate
            );

            if (currentItem) {
                if (mode === 'horizontal') renderHorizontalTimeline(currentItem);
                else renderVerticalTimeline(currentItem);
            }
        }

        function renderTimeline(item) {
            // Dispatcher
            if (timelineMode === 'horizontal') {
                renderHorizontalTimeline(item);
            } else {
                renderVerticalTimeline(item);
            }
        }

        // --- HORIZONTAL GANTT (UX POLISHED) ---
        function renderHorizontalTimeline(item) {
            const container = document.getElementById('h-timeline-container');
            container.innerHTML = '';

            // Remove previous fixed sizing styles from the container wrapper if any
            const wrapper = document.getElementById('timeline-view-horizontal');
            // Ensure we don't accidentally hide it if it's supposed to be shown
            const isHidden = wrapper.classList.contains('hidden');
            wrapper.className = `border border-white/10 rounded-lg bg-slate-900/50 flex flex-col h-[320px] ${isHidden ? 'hidden' : ''}`;
            // We set height fixed or max-height to ensure scrolling works

            // Reset inner container to standard block
            container.className = "relative flex-1 overflow-auto custom-scrollbar";
            container.style.width = '100%';
            container.style.height = '100%';

            const pxPerMin = 2 * timelineZoom;
            const startHour = 4; // 4 AM
            const endHour = 22;  // 10 PM
            const totalMinutes = (endHour - startHour) * 60;
            const totalWidth = totalMinutes * pxPerMin;

            // Layout Constants
            const labelWidth = 140;
            const rowHeight = 60;

            // 1. Time Axis Header (Sticky Top)
            const header = document.createElement('div');
            header.className = "sticky top-0 z-30 flex items-end border-b border-white/10 bg-slate-900/95 backdrop-blur shadow-sm";
            header.style.height = '40px';
            header.style.minWidth = `${totalWidth + labelWidth}px`; // Ensure it spans properly

            // Spacer for Label Column
            const corner = document.createElement('div');
            corner.className = "sticky left-0 z-40 w-[140px] flex-shrink-0 bg-slate-900 border-r border-white/10";
            header.appendChild(corner);

            // Time Marks Container
            const axisTrack = document.createElement('div');
            axisTrack.className = "relative flex-1 h-full";

            for (let h = startHour; h <= endHour; h++) {
                const left = (h - startHour) * 60 * pxPerMin;
                // Major Hour Mark
                const mark = document.createElement('div');
                mark.className = 'absolute bottom-0 border-l border-slate-600 h-3';
                mark.style.left = `${left}px`;

                // Label
                const label = document.createElement('span');
                const hourDisplay = h > 12 ? h - 12 : (h === 0 || h === 24 ? 12 : h);
                const ampm = h >= 12 && h < 24 ? 'PM' : 'AM';
                label.className = "absolute -top-5 -left-4 w-8 text-center text-[10px] font-bold text-slate-400 font-mono";
                label.innerText = `${hourDisplay} ${ampm}`;
                mark.appendChild(label);

                axisTrack.appendChild(mark);

                // Half-hour mark (subtle)
                if (h < endHour) {
                    const halfLeft = left + (30 * pxPerMin);
                    const halfMark = document.createElement('div');
                    halfMark.className = 'absolute bottom-0 border-l border-white/5 h-1.5';
                    halfMark.style.left = `${halfLeft}px`;
                    axisTrack.appendChild(halfMark);
                }
            }
            header.appendChild(axisTrack);
            container.appendChild(header);

            // 2. Rows Container
            const rowsContainer = document.createElement('div');
            rowsContainer.className = "relative";
            rowsContainer.style.minWidth = `${totalWidth + labelWidth}px`;

            // Helper: Create Row
            const createRow = (name, colorClass, isStriped) => {
                const row = document.createElement('div');
                row.className = `flex group h-[60px] border-b border-white/5 ${isStriped ? 'bg-white/[0.02]' : ''} hover:bg-white/[0.04] transition-colors`;

                // Sticky Label
                const label = document.createElement('div');
                label.className = `sticky left-0 z-20 w-[140px] flex-shrink-0 flex items-center justify-end pr-4 text-xs font-bold border-r border-white/10 ${colorClass} bg-slate-900/90 backdrop-blur group-hover:bg-slate-800/90 transition-colors`;
                label.innerText = name;
                row.appendChild(label);

                // Timeline Track
                const track = document.createElement('div');
                track.className = "relative flex-1 h-full";

                // Vertical Grid Lines
                for (let h = startHour; h <= endHour; h++) {
                    const left = (h - startHour) * 60 * pxPerMin;
                    const line = document.createElement('div');
                    line.className = "absolute top-0 bottom-0 border-l border-white/5 pointer-events-none";
                    line.style.left = `${left}px`;
                    track.appendChild(line);
                }

                row.appendChild(track);
                return { row, track };
            };

            const stRowObj = createRow('ServiceTitan', 'text-blue-400', false);
            const samTripRowObj = createRow('Samsara Move', 'text-emerald-400', true);
            const samStopRowObj = createRow('Samsara Stop', 'text-amber-400', false);

            rowsContainer.appendChild(stRowObj.row);
            rowsContainer.appendChild(samTripRowObj.row);
            rowsContainer.appendChild(samStopRowObj.row);

            container.appendChild(rowsContainer);

            // --- TIME PARSING & RENDER HELPERS ---
            const resolveTime = (timeStr) => {
                if (!timeStr) return null;
                const ampmParts = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
                if (ampmParts) {
                    let h = parseInt(ampmParts[1]);
                    const m = parseInt(ampmParts[2]);
                    const p = ampmParts[3].toUpperCase();
                    if (p === 'PM' && h < 12) h += 12;
                    if (p === 'AM' && h === 12) h = 0;
                    return h * 60 + m;
                }
                const time24Parts = timeStr.match(/(\d{2}):(\d{2})/);
                if (time24Parts) return parseInt(time24Parts[1]) * 60 + parseInt(time24Parts[2]);
                return null;
            };

            const renderBar = (track, startStr, endStr, durationHours, colorBg, title) => {
                const startMinsOfDay = resolveTime(startStr);
                let durationMins = 0;

                if (durationHours !== undefined && durationHours !== null) {
                    durationMins = durationHours * 60;
                } else {
                    const endMinsOfDay = resolveTime(endStr);
                    if (startMinsOfDay !== null && endMinsOfDay !== null) {
                        durationMins = endMinsOfDay - startMinsOfDay;
                    }
                }

                if (startMinsOfDay === null || durationMins <= 0) return;

                const startOffset = startMinsOfDay - (startHour * 60);
                if (startOffset < -durationMins) return;

                const left = (Math.max(0, startOffset) * pxPerMin);
                let width = durationMins * pxPerMin;
                if (startOffset < 0) width += (startOffset * pxPerMin);

                const bar = document.createElement('div');
                // Added distinct gradient and shadow
                bar.className = `absolute top-[12px] h-[36px] rounded-md shadow-md border border-white/20 cursor-help ${colorBg} hover:brightness-110 transition z-10 flex items-center px-2 overflow-hidden`;
                bar.style.left = `${left}px`;
                bar.style.width = `${Math.max(2, width)}px`;
                bar.title = `${title} (${startStr} - ${endStr || '?'})`;

                // Inner Label for wider bars
                if (width > 60) {
                    bar.innerHTML = `<span class="text-[10px] font-bold text-white/90 truncate drop-shadow-md select-none">${title}</span>`;
                }

                track.appendChild(bar);
            };

            // --- DATA INJECTION ---
            if (item.serviceTitan.activities) {
                item.serviceTitan.activities.forEach(act => {
                    let color = 'bg-gradient-to-r from-blue-600 to-blue-500';
                    if (act.activityType.toLowerCase().includes('travel')) color = 'bg-gradient-to-r from-blue-500 to-cyan-500';
                    if (act.activityType.toLowerCase().includes('shop')) color = 'bg-gradient-to-r from-indigo-500 to-purple-500';
                    renderBar(stRowObj.track, act.startTime, act.endTime, act.duration, color, act.activityType);
                });
            }

            if (item.samsara.trips) {
                item.samsara.trips.forEach(trip => {
                    let color = 'bg-gradient-to-r from-emerald-600 to-emerald-500';
                    if (trip.flagged) color = 'bg-gradient-to-r from-red-600 to-red-500';
                    else if (trip.distance < 0.5) color = 'bg-gradient-to-r from-slate-600 to-slate-500';
                    renderBar(samTripRowObj.track, trip.startTime, trip.endTime, trip.duration, color, `Trip: ${trip.distance} mi`);
                });
            }

            if (item.samsara.gaps) {
                item.samsara.gaps.forEach(gap => {
                    if (gap.isPotentialWork) {
                        renderBar(samStopRowObj.track, gap.startTime, gap.endTime, gap.duration, 'bg-amber-500/80 dashed-border', 'Potential Work');
                    }
                });
            }
            if (item.samsara.stops) {
                item.samsara.stops.forEach(stop => {
                    renderBar(samStopRowObj.track, stop.arrivalTime, stop.departureTime, null, 'bg-slate-700/50', `Stop: ${stop.location}`);
                });
            }
        }

        // --- VERTICAL TIMELINE RENDERER (Renamed) ---
        function renderVerticalTimeline(item) {
            // ... [Existing Logic] ...
            // Just need to ensure element IDs are correct since I wrapped them


            const colSt = document.getElementById('col-st');

            const colSam = document.getElementById('col-sam');

            const colAxis = document.getElementById('col-axis');



            colSt.innerHTML = '';

            colSam.innerHTML = '';

            colAxis.innerHTML = '';



            // Config: Pixels per minute

            const pxPerMin = 2 * timelineZoom;

            const startHour = 4; // Start at 4 AM

            const endHour = 22;  // End at 10 PM

            const totalMinutes = (endHour - startHour) * 60;

            const totalHeight = totalMinutes * pxPerMin;



            // Set grid height

            document.getElementById('v-timeline-grid').style.height = `${totalHeight}px`;



            // Render Axis (Every hour)

            for (let h = startHour; h <= endHour; h++) {

                const top = (h - startHour) * 60 * pxPerMin;

                const el = document.createElement('div');

                el.className = 'v-time-marker';

                el.style.top = `${top}px`;

                el.innerText = formatHour(h);

                colAxis.appendChild(el);

            }



            // Helper: Time to Top/Height

            const getPos = (timeStr, duration) => {

                if (!timeStr) return { top: 0, height: 0 };

                try {
                    let h, m;

                    // Try AM/PM format first (e.g., "6:30 AM")
                    const ampmParts = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
                    if (ampmParts) {
                        h = parseInt(ampmParts[1]);
                        m = parseInt(ampmParts[2]);
                        const p = ampmParts[3].toUpperCase();
                        if (p === 'PM' && h < 12) h += 12;
                        if (p === 'AM' && h === 12) h = 0;
                    } else {
                        // Try 24-hour format (e.g., "06:30:00" or "2025-12-08 06:41:10")
                        const time24Parts = timeStr.match(/(\d{2}):(\d{2}):?(\d{2})?/);
                        if (time24Parts) {
                            h = parseInt(time24Parts[1]);
                            m = parseInt(time24Parts[2]);
                        }
                    }

                    if (h !== undefined && m !== undefined) {
                        const minutesFromStart = (h * 60 + m) - (startHour * 60);

                        const top = Math.max(0, minutesFromStart * pxPerMin);

                        const height = Math.max(8, duration * 60 * pxPerMin); // Min height 8px for better density

                        return { top, height };

                    }

                } catch (e) { console.error('Time parse error:', e, timeStr); }

                return { top: 0, height: 0 };

            };



            // Render ServiceTitan

            item.serviceTitan.activities.forEach(act => {

                const { top, height } = getPos(act.startTime, act.duration);

                const el = document.createElement('div');



                let bg = 'bg-blue-500/20 border-blue-500/50 text-blue-200';

                if (act.activityType.toLowerCase().includes('travel')) bg = 'bg-blue-400/20 border-blue-400/50 text-blue-200';

                if (act.activityType.toLowerCase().includes('shop')) bg = 'bg-indigo-400/20 border-indigo-400/50 text-indigo-200';



                el.className = `v-event-block ${bg} flex flex-col justify-center px-2`;

                el.style.top = `${top}px`;

                el.style.height = `${height}px`;



                el.innerHTML = `

                        <div class="font-bold truncate">${act.activityType}</div>

                        <div class="text-[9px] opacity-70 truncate">${act.jobNumber || 'Non-Job'}</div>

                    `;

                // Interactive Tooltip
                el.dataset.h = height; // Store original height
                const tooltipText = `<div class="font-bold border-b border-white/10 pb-1 mb-1">${act.activityType}</div>
                                     <div class="space-y-0.5">
                                        <div><span class="text-slate-400">Range:</span> ${formatTimeDisplay(act.startTime)} - ${formatTimeDisplay(act.endTime)}</div>
                                        <div><span class="text-slate-400">Dur:</span> ${formatDuration(act.duration)} (${act.duration.toFixed(2)}h)</div>
                                        <div><span class="text-slate-400">Job:</span> ${act.jobNumber || 'N/A'}</div>
                                     </div>`;

                el.addEventListener('mouseenter', (e) => {
                    showTooltip(e, tooltipText, 'bg-slate-800/95');
                    // Safer Expansion: Only expand if content overflows or block is tiny
                    if (el.scrollHeight > el.clientHeight || el.clientHeight < 48) {
                        el.style.height = 'auto';
                        el.style.minHeight = Math.max(48, el.scrollHeight) + 'px';
                    }
                });
                el.addEventListener('mouseleave', () => {
                    hideTooltip();
                    // Reset to original inline height
                    el.style.height = el.dataset.h + 'px';
                    el.style.minHeight = '8px';
                });
                el.addEventListener('mousemove', moveTooltip);
                // el.title removed in favor of custom tooltip

                colSt.appendChild(el);

            });



            // Render Samsara Trips

            item.samsara.trips.forEach(trip => {

                const { top, height } = getPos(trip.startTime, trip.duration);

                const el = document.createElement('div');



                let bg = 'bg-emerald-500/20 border-emerald-500/50 text-emerald-200';

                if (trip.flagged) bg = 'bg-red-500/20 border-red-500/50 text-red-200';

                else if (trip.distance < 0.5) bg = 'bg-slate-600/20 border-slate-500/50 text-slate-300';



                el.className = `v-event-block ${bg} flex flex-col justify-center px-2`;

                el.style.top = `${top}px`;

                el.style.height = `${height}px`;



                const icon = trip.distance < 0.5 ? '<i class="fa-solid fa-parking"></i>' : '<i class="fa-solid fa-car"></i>';



                el.innerHTML = `

                        <div class="font-bold truncate flex items-center gap-2">${icon} ${trip.distance < 0.5 ? 'Stopped' : trip.distance + ' mi'}</div>

                        <div class="text-[9px] opacity-70 truncate">${trip.startLocation}</div>

                    `;

                // Interactive Tooltip
                el.dataset.h = height; // Store original height
                const tooltipText2 = `<div class="font-bold border-b border-white/10 pb-1 mb-1">${trip.startLocation} &rarr; ${trip.endLocation}</div>
                                      <div class="space-y-0.5">
                                        <div><span class="text-slate-400">Range:</span> ${formatTimeDisplay(trip.startTime)} - ${formatTimeDisplay(trip.endTime)}</div>
                                        <div><span class="text-slate-400">Dist:</span> ${trip.distance} mi</div>
                                      </div>`;

                el.addEventListener('mouseenter', (e) => {
                    showTooltip(e, tooltipText2, bg.includes('red') ? 'bg-red-900/90' : 'bg-slate-800/95');
                    // Safer Expansion
                    if (el.scrollHeight > el.clientHeight || el.clientHeight < 48) {
                        el.style.height = 'auto';
                        el.style.minHeight = Math.max(48, el.scrollHeight) + 'px';
                    }
                });
                el.addEventListener('mouseleave', () => {
                    hideTooltip();
                    el.style.height = el.dataset.h + 'px';
                    el.style.minHeight = '8px';
                });
                el.addEventListener('mousemove', moveTooltip);

                colSam.appendChild(el);

            });

            // Render Samsara Gaps (Potential Work Periods)
            if (item.samsara.gaps && item.samsara.gaps.length > 0) {
                item.samsara.gaps.forEach(gap => {
                    const { top, height } = getPos(gap.startTime, gap.duration);
                    const el = document.createElement('div');

                    // Yellow/amber for potential work, lighter gray for normal gaps
                    let bg = gap.isPotentialWork
                        ? 'bg-amber-500/30 border-amber-500/60 text-amber-200'
                        : 'bg-slate-700/20 border-slate-600/40 text-slate-400';

                    el.className = `v-event-block ${bg} flex flex-col justify-center px-2 border-dashed`;
                    el.style.top = `${top}px`;
                    el.style.height = `${height}px`;

                    const icon = gap.isPotentialWork
                        ? '<i class="fa-solid fa-wrench"></i>'
                        : '<i class="fa-solid fa-clock"></i>';

                    // Determine label based on gap characteristics
                    let gapLabel, gapTooltipTitle;
                    if (gap.isPotentialWork) {
                        gapLabel = 'Unexplained Stop';
                        gapTooltipTitle = 'UNEXPLAINED STOP';
                    } else if (gap.duration >= 2.0) {
                        gapLabel = 'Verified Work';
                        gapTooltipTitle = 'VERIFIED WORK PERIOD';
                    } else {
                        gapLabel = 'Brief Stop';
                        gapTooltipTitle = 'BRIEF STOP';
                    }

                    el.innerHTML = `

                            <div class="font-bold truncate flex items-center gap-2">${icon} ${gapLabel}</div>

                            <div class="text-[9px] opacity-70 truncate">${formatDuration(gap.duration)} at ${gap.location}</div>

                        `;
                    const tooltipText3 = `<div class="font-bold border-b border-white/10 pb-1 mb-1">${gapTooltipTitle}</div>
                                          <div class="space-y-0.5">
                                            <div><span class="text-slate-400">Range:</span> ${formatTimeDisplay(gap.startTime)} - ${formatTimeDisplay(gap.endTime)}</div>
                                            <div><span class="text-slate-400">Dur:</span> ${formatDuration(gap.duration)} (${gap.duration.toFixed(2)}h)</div>
                                            <div class="text-[10px] text-slate-500 mt-1">${gap.location}</div>
                                            ${!gap.isPotentialWork && gap.duration >= 2.0 ? '<div class="text-[10px] text-green-400 mt-1"><i class="fa-solid fa-check-circle"></i> Matches claimed onsite work</div>' : ''}
                                          </div>`;

                    el.dataset.h = height;
                    el.addEventListener('mouseenter', (e) => {
                        showTooltip(e, tooltipText3, gap.isPotentialWork ? 'bg-amber-900/90' : 'bg-slate-800/95');
                        // Safer Expansion
                        if (el.scrollHeight > el.clientHeight || el.clientHeight < 48) {
                            el.style.height = 'auto';
                            el.style.minHeight = Math.max(48, el.scrollHeight) + 'px';
                        }
                    });
                    el.addEventListener('mouseleave', () => {
                        hideTooltip();
                        el.style.height = el.dataset.h + 'px';
                        el.style.minHeight = '8px';
                    });
                    el.addEventListener('mousemove', moveTooltip);
                    colSam.appendChild(el);
                });
            }

        }



        function formatHour(h) {

            const p = h >= 12 ? 'PM' : 'AM';

            const d = h % 12 || 12;

            return `${d} ${p}`;

        }

        // Helper: Format any time string to HH:MM AM/PM display
        function formatTimeDisplay(timeStr) {
            if (!timeStr) return '';
            // Match HH:MM:SS or YYYY-MM-DD HH:MM:SS patterns
            const match = timeStr.match(/(\d{2}):(\d{2})/);
            if (match) {
                let h = parseInt(match[1]);
                const m = match[2];
                const p = h >= 12 ? 'PM' : 'AM';
                h = h % 12 || 12;
                return `${h}:${m} ${p}`;
            }
            return timeStr;
        }

        // Helper: Convert decimal hours to readable format (e.g., "2h 30m")
        function formatDuration(decimalHours) {
            if (decimalHours == null || isNaN(decimalHours)) return '0h 0m';

            // Round to nearest minute (1/60th of an hour = 0.0167)
            const totalMinutes = Math.round(decimalHours * 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            if (hours === 0) {
                return `${minutes}m`;
            } else if (minutes === 0) {
                return `${hours}h`;
            } else {
                return `${hours}h ${minutes}m`;
            }
        }

        // Helper: Format duration with both decimal and readable format
        function formatDurationBoth(decimalHours) {
            const readable = formatDuration(decimalHours);
            const decimal = decimalHours.toFixed(2);
            return `${readable} (${decimal}h)`;
        }

        // Helper: Format date to American MM/DD/YYYY format
        function formatDateAmerican(dateStr) {
            if (!dateStr) return '';
            // Handle YYYY-MM-DD format
            const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                const [_, year, month, day] = match;
                return `${month}/${day}/${year}`;
            }
            return dateStr;
        }


        // --- LIST RENDERER ---

        function renderLists(item) {

            const listSt = document.getElementById('list-st');

            const listSam = document.getElementById('list-sam');

            listSt.innerHTML = '';

            listSam.innerHTML = '';



            // ServiceTitan

            item.serviceTitan.activities.forEach(act => {

                const el = document.createElement('div');

                el.className = 'p-3 rounded bg-slate-800/30 border border-white/5 flex gap-3 hover:bg-slate-800/50 transition';

                el.innerHTML = `

                        <div class="w-16 text-[10px] font-mono text-slate-500 pt-1 shrink-0 text-right">

                            <div>${formatTimeDisplay(act.startTime)}</div>

                            <div class="text-slate-600">|</div>

                            <div>${formatTimeDisplay(act.endTime)}</div>

                        </div>

                        <div class="flex-1 min-w-0">

                            <div class="font-bold text-blue-200 text-sm truncate">${act.activityType}</div>

                            <div class="text-xs text-slate-400 truncate">${act.jobNumber || 'Non-Job'}</div>

                            <div class="text-[10px] text-slate-500 mt-1">${act.customer || ''}</div>

                        </div>

                        <div class="text-xs font-mono text-slate-400">${formatDuration(act.duration)}</div>

                    `;

                listSt.appendChild(el);

            });



            // Samsara Trips & Gaps (interleaved chronologically)
            const samEvents = [];

            // Add trips
            item.samsara.trips.forEach(trip => {
                samEvents.push({ type: 'trip', data: trip, time: trip.startTime });
            });

            // Add gaps
            if (item.samsara.gaps) {
                item.samsara.gaps.forEach(gap => {
                    samEvents.push({ type: 'gap', data: gap, time: gap.startTime });
                });
            }

            // Sort chronologically (simple string comparison works for HH:MM AM/PM)
            samEvents.sort((a, b) => {
                // Convert to comparable format
                const timeA = new Date('1970-01-01 ' + a.time);
                const timeB = new Date('1970-01-01 ' + b.time);
                return timeA - timeB;
            });

            // Render events
            samEvents.forEach(event => {
                if (event.type === 'trip') {
                    const trip = event.data;
                    const el = document.createElement('div');
                    const isStop = trip.distance < 0.5;
                    el.className = `p-3 rounded border flex gap-3 transition ${trip.flagged ? 'bg-red-500/10 border-red-500/20' : 'bg-slate-800/30 border-white/5 hover:bg-slate-800/50'}`;
                    el.innerHTML = `
                    <div class="w-16 text-[10px] font-mono text-slate-500 pt-1 shrink-0 text-right">
                        <div>${formatTimeDisplay(trip.startTime)}</div>
                        <div class="text-slate-600">|</div>
                        <div>${formatTimeDisplay(trip.endTime)}</div>
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col justify-between">
                        <!-- Start Location aligned with start time -->
                        <div class="text-[11px] font-semibold text-slate-200 flex items-center gap-2">
                            <i class="fa-solid fa-circle-dot text-emerald-400 text-[8px]"></i>
                            <span class="truncate">${trip.startLocation}</span>
                        </div>
                        <!-- Journey indicator -->
                        <div class="flex items-center gap-2 text-slate-600 my-0.5 pl-3">
                            <div class="flex-1 border-t border-slate-600 border-dashed"></div>
                        </div>
                        <!-- End Location aligned with end time -->
                        <div class="text-[11px] font-semibold text-slate-200 flex items-center gap-2">
                            <i class="fa-solid fa-location-dot text-red-400 text-[8px]"></i>
                            <span class="truncate">${isStop ? 'Stopped' : trip.endLocation}</span>
                        </div>
                        ${trip.flagged ? `<div class="text-[10px] text-red-400 mt-1 font-bold"><i class="fa-solid fa-triangle-exclamation"></i> ${trip.note}</div>` : ''}
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-mono text-slate-400">${formatDuration(trip.duration)}</div>
                        <div class="text-[10px] text-slate-500">${trip.distance} mi</div>
                    </div>
                `;
                    listSam.appendChild(el);
                } else if (event.type === 'gap') {
                    const gap = event.data;
                    const el = document.createElement('div');
                    const isPotentialWork = gap.isPotentialWork;
                    el.className = `p-3 rounded border flex gap-3 transition ${isPotentialWork ? 'bg-amber-500/10 border-amber-500/30 border-dashed' : 'bg-slate-700/10 border-slate-600/20 border-dashed'}`;
                    // Determine label and styling based on gap characteristics
                    let gapLabel, gapIcon, gapNote;
                    if (isPotentialWork) {
                        gapLabel = 'Unexplained Stop';
                        gapIcon = 'fa-triangle-exclamation';
                        gapNote = '<div class="text-[10px] text-amber-400 mt-1 font-bold"><i class="fa-solid fa-info-circle"></i> No matching work activity found</div>';
                    } else if (gap.duration >= 2.0) {
                        gapLabel = 'Verified Work Period';
                        gapIcon = 'fa-check-circle';
                        gapNote = '<div class="text-[10px] text-green-400 mt-1 font-bold"><i class="fa-solid fa-check"></i> Matches claimed onsite work</div>';
                    } else {
                        gapLabel = 'Brief Stop';
                        gapIcon = 'fa-clock';
                        gapNote = '';
                    }

                    el.innerHTML = `
                    <div class="w-16 text-[10px] font-mono text-slate-500 pt-1 shrink-0 text-right">
                        <div>${formatTimeDisplay(gap.startTime)}</div>
                        <div class="text-slate-600">|</div>
                        <div>${formatTimeDisplay(gap.endTime)}</div>
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <div class="text-[11px] font-semibold ${isPotentialWork ? 'text-amber-300' : gap.duration >= 2.0 ? 'text-green-400' : 'text-slate-400'} flex items-center gap-2">
                            <i class="fa-solid ${gapIcon} text-[8px]"></i>
                            <span class="truncate">${gapLabel}</span>
                        </div>
                        <div class="text-[10px] text-slate-500 mt-1">Parked at ${gap.location}</div>
                        ${gapNote}
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-mono ${isPotentialWork ? 'text-amber-300' : gap.duration >= 2.0 ? 'text-green-400' : 'text-slate-400'}">${formatDuration(gap.duration)}</div>
                    </div>
                `;
                    listSam.appendChild(el);
                }
            });

        }



    </script>

    <!-- Custom Tooltip Container -->
    <div id="v-tooltip"></div>

    <script>
        // --- CUSTOM DATA TOOLTIP ---
        const tooltipEl = document.getElementById('v-tooltip');

        function showTooltip(e, content, colorClass) {
            tooltipEl.innerHTML = content;
            tooltipEl.className = `${colorClass || 'bg-slate-900'} fixed z-[1000] backdrop-blur-md border border-white/10 text-white rounded-lg px-3 py-2 text-xs shadow-2xl pointer-events-none transition-opacity duration-75`;
            tooltipEl.style.opacity = '1';
            moveTooltip(e);
        }

        function hideTooltip() {
            tooltipEl.style.opacity = '0';
        }

        function moveTooltip(e) {
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            // Prevent going off screen
            const rect = tooltipEl.getBoundingClientRect();
            let finalX = x;
            let finalY = y;
            if (x + rect.width > window.innerWidth) finalX = e.clientX - rect.width - 10;
            if (y + rect.height > window.innerHeight) finalY = e.clientY - rect.height - 10;

            tooltipEl.style.left = finalX + 'px';
            tooltipEl.style.top = finalY + 'px';
        }
    </script>
</body>

</html>
